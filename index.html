<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NameForge</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#071022; color:#E6EEF9; }
    .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); cursor:pointer; user-select:none; display: inline-flex; align-items: center; gap: 4px; }
    .chip.active, .chip-selected { background: linear-gradient(90deg,#294e86,#2b6fb3); color:white; box-shadow:0 6px 18px rgba(41,78,134,0.14) }
    .spinner{ border:4px solid rgba(255,255,255,0.06); border-top-color:#60a5fa; border-radius:999px; width:36px; height:36px; animation:spin 0.9s linear infinite } @keyframes spin{ to{transform:rotate(360deg)} }
    .like-btn.active { fill: #60a5fa; color: #60a5fa; }
    .modal-backdrop { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); animation: fadeIn 150ms ease-out; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal-content { animation: slideIn 200ms ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }
    .mode-toggle { display: flex; background: rgba(255,255,255,0.03); border-radius: 999px; padding: 4px; }
    .mode-toggle button.chip { flex: 1; text-align: center; padding: 6px 10px; border-radius: 999px; border: none; background: transparent; color: #9fb0c7; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 150ms ease-out; }
    .mode-toggle button.chip.active { background: linear-gradient(90deg,#294e86,#2b6fb3); color: white; box-shadow: 0 4px 10px rgba(41,78,134,0.1); }
    .toggle-switch { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .source-lang-indicator { font-size: 10px; margin-left: 6px; color: #facc15; }
    .name-card { background:#081426; border:1px solid #123047; border-radius: 0.25rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-6"></div>

  <script>
(function () {
  // --- CONFIG ---
  const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/";
  const APP_VERSION = "7.1"; // Version bump for E-mode cleanup
  const DEFAULT_COUNT = 8;
  const API_TIMEOUT_MS = 30000;
  const LANG_OPTIONS = ["Turkish","Nordic","Latin","Celtic","Japanese","Greek","Spanish","Irish", "Russian", "Korean", "English"];
  const THEME_OPTIONS = ["Nature","Cosmic","Balance","Strength","Water","Light","Shadow","Music", "Fire", "Mountain", "Ocean", "Sky", "Forest", "Mythic"];
  const STYLE_OPTIONS = ["Lyrical & Melodic","Archaic & Mythic","Minimalist & Modern","Heroic & Resonant", "Elegant & Refined", "Grounded & Earthy", "Mystical & Ethereal"];

  // --- State ---
  const appState = {
    version: APP_VERSION,
    apiKey: "",
    isLoading: false,
    error: null,
    results: [],
    likedNames: [],
    userBlacklist: [],
    sessionGeneratedNames: [],
    recentErrors: [],
    options: {
        mode: 'forge',
        harmonizerIsAllLanguages: false,
        selectedLanguages: ["Spanish", "Irish"],
        selectedThemes: ["Light","Balance"],
        selectedStyle: "Lyrical & Melodic",
        gender: "Unisex",
        model: "models/gemini-2.5-pro",
        surname: "",
        siblingNames: "",
        firstNameForMiddle: "",
    }
  };
  
  const ui = {
      root: document.getElementById('app'),
      controls: {},
      results: {},
  };

  // --- UTILITIES ---
  function debounce(func, delay) {
    let timeout;
    function wrapper(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    }
    wrapper.cancel = () => clearTimeout(timeout);
    return wrapper;
  }

  const debouncedSaveState = debounce(() => {
    const minimalState = {
        likedNames: appState.likedNames,
        userBlacklist: appState.userBlacklist,
        options: appState.options
    };
    localStorage.setItem('nameForgeState_v7.1', JSON.stringify(minimalState));
  }, 1500);

  const stateManager = {
    setOption(key, value) {
        appState.options[key] = value;
        debouncedSaveState();
    },
    setMode(mode) {
        if (appState.options.mode === mode) return;
        this.setOption('mode', mode);
        const isForge = mode === 'forge';
        ui.controls.themesSection.style.display = isForge ? '' : 'none';
        ui.controls.styleSection.style.display = isForge ? '' : 'none';
        ui.controls.advancedContextSection.style.display = isForge ? '' : 'none';
        ui.controls.harmonizerToggleSection.style.display = isForge ? 'none' : 'flex';
        document.querySelectorAll('.mode-toggle .chip').forEach(c => c.classList.remove('active'));
        document.querySelector(`.mode-toggle .chip[data-mode="${mode}"]`)?.classList.add('active');
        appState.results = []; appState.sessionGeneratedNames = [];
        updateResultsPanel(); updateGenerateButtonState();
    },
    appendSessionName(item) {
        appState.sessionGeneratedNames.push(item);
        if (appState.sessionGeneratedNames.length > 20) appState.sessionGeneratedNames.slice(-20);
    },
    pushError(msg) {
        appState.recentErrors.push({ timestamp: new Date().toISOString(), message: msg });
        appState.recentErrors = appState.recentErrors.slice(-5);
    },
    toggleArrayOption(stateKey, value) {
        const arr = appState.options[stateKey];
        const index = arr.indexOf(value);
        if (index > -1) arr.splice(index, 1);
        else {
            arr.push(value);
            if (stateKey === 'selectedLanguages' && arr.length > 3) arr.shift();
            if (stateKey === 'selectedThemes' && arr.length > 2) arr.shift();
        }
    },
    toggleLike(name) {
        const item = appState.sessionGeneratedNames.find(n => n.name === name);
        if (!item) return;
        item.liked = !item.liked;
        if (item.liked) appState.likedNames.push(item);
        else appState.likedNames = appState.likedNames.filter(n => n.name !== name);
        const card = ui.results.panel.querySelector(`[data-name="${name}"]`);
        if (card) updateCardUI(card, item);
        debouncedSaveState();
    },
    toggleBlacklist(name) {
        const nameLower = name.toLowerCase();
        const isBlacklisted = appState.userBlacklist.includes(nameLower);
        if (isBlacklisted) appState.userBlacklist = appState.userBlacklist.filter(n => n !== nameLower);
        else {
            appState.userBlacklist.push(nameLower);
            const item = appState.sessionGeneratedNames.find(n => n.name === name);
            if(item?.liked) this.toggleLike(name);
        }
        updateResultsPanel(); debouncedSaveState();
    }
  };
  
  function loadState() {
      try {
        const saved = localStorage.getItem('nameForgeState_v7.1');
        if (saved) {
            const parsed = JSON.parse(saved);
            Object.assign(appState.options, parsed.options);
            appState.likedNames = parsed.likedNames || [];
            appState.userBlacklist = parsed.userBlacklist || [];
        }
      } catch (e) { console.warn("Could not load state:", e); }
  }
  
  // --- UI Creation ---
  function el(tag, cls = '') {
      const element = document.createElement(tag);
      if (cls) element.className = cls;
      return element;
  }

  function createChip({ text, classes = [], data = {}, onClick }) {
    const chipEl = el('button', `chip ${classes.join(' ')}`);
    chipEl.textContent = text;
    Object.entries(data).forEach(([k, v]) => chipEl.dataset[k] = v);
    if (onClick) chipEl.addEventListener('click', onClick);
    return chipEl;
  }

  function createControlSection(label, control) {
      const section = el('div');
      section.innerHTML = `<label class="text-sm font-medium">${label}</label>`;
      control.classList.add('mt-1');
      section.appendChild(control);
      return section;
  }

  function createLabeledInput({ stateKey, placeholder }) {
    const input = el('input', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
    input.value = appState.options[stateKey] || '';
    input.placeholder = placeholder;
    input.addEventListener('input', (e) => stateManager.setOption(stateKey, e.target.value));
    return input;
  }
  
  function createSelectControl(options, selectedValue, stateKey) {
      const select = el('select', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
      options.forEach(opt => {
          const optionEl = el('option');
          optionEl.value = opt;
          optionEl.textContent = opt;
          if (opt === selectedValue) optionEl.selected = true;
          select.append(optionEl);
      });
      select.addEventListener('change', (e) => stateManager.setOption(stateKey, e.target.value));
      return select;
  }

  function updateChipSelector(container, options, stateKey) {
    container.innerHTML = '';
    const stateArray = appState.options[stateKey];
    options.forEach(opt => {
        const selected = stateArray.includes(opt);
        const chip = createChip({
            text: opt, classes: [selected ? 'chip-selected' : ''], data: { key: opt },
            onClick: () => {
                stateManager.toggleArrayOption(stateKey, opt);
                updateChipSelector(container, options, stateKey);
                updateGenerateButtonState();
            }
        });
        container.appendChild(chip);
    });
  }
  
  // --- API & DATA PROCESSING ---
  function parseApiResponse(text) {
    if (!text) return [];
    try {
        return JSON.parse(text).names || [];
    } catch {
        const match = text.match(/\[.*\]/s);
        if (match) try { return JSON.parse(match[0]); } catch {}
    }
    return [];
  }
  
  function processApiResponse(rawArray) {
    if (!rawArray?.length) return [];
    return rawArray.map(it => {
      let name = (it.name || "").toString().trim();
      if (!name) return null;
      const base = { name, liked: false };
      if (appState.options.mode === 'forge') {
          return { ...base,
            meaning: (it.meaning || "").toString().trim(),
            roots: it.roots || [],
            cluster: appState.options.selectedStyle,
          };
      } else {
          return { ...base, pronunciations: it.pronunciations || [], semanticCheck: it.semanticCheck || "Unknown" };
      }
    }).filter(Boolean);
  }

  // --- UI Rendering ---
  function updateResultsPanel() {
    if (appState.isLoading) {
        ui.results.panel.innerHTML = `<div class="flex flex-col items-center justify-center py-8 gap-4"><div class="spinner"></div></div>`;
        return;
    }
    ui.results.panel.innerHTML = '';
    const visibleNames = appState.sessionGeneratedNames.filter(item => !appState.userBlacklist.includes(item.name.toLowerCase()));
    if(visibleNames.length === 0) {
        ui.results.panel.innerHTML = '<div class="flex-1 flex items-center justify-center small-muted h-full">No names yet — click Generate.</div>';
        return;
    }
    const grid = el('div','grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2');
    visibleNames.forEach(item => grid.appendChild(createNameCard(item)));
    ui.results.panel.appendChild(grid);
  }

  function updateCardUI(card, item) {
    card.querySelector('.like-btn')?.classList.toggle('active', !!item.liked);
  }

  function createNameCard(item) {
    const card = el('div', 'name-card');
    card.dataset.name = item.name;
    const header = el('div', 'text-xl font-semibold');
    header.textContent = item.name;
    card.appendChild(header);

    if (appState.options.mode === 'forge') {
        const meaning = el('div', 'italic small-muted');
        meaning.textContent = item.meaning;
        card.appendChild(meaning);
        if (item.roots) {
            // IMPLEMENTATION: renderOrigins logic folded directly into this function.
            const originsDiv = el('div', 'flex flex-wrap gap-2 mt-1');
            item.roots.forEach(r => originsDiv.appendChild(createChip({ text: r, classes: ['origin-default', 'text-xs'] })));
            card.appendChild(originsDiv);
        }
    } else {
        const validation = el('div', 'text-xs');
        const statusColor = item.semanticCheck === 'Pass' ? 'text-green-400' : 'text-yellow-400';
        validation.innerHTML = `<strong>Validation:</strong> <span class="${statusColor}">${item.semanticCheck}</span>`;
        card.appendChild(validation);
        const pronunciations = el('div', 'flex flex-col gap-1 mt-2 text-sm');
        item.pronunciations?.forEach(p => pronunciations.insertAdjacentHTML('beforeend', `<div><strong>${p.lang}:</strong> <span class="italic small-muted">/${p.phonetic}/</span></div>`));
        card.appendChild(pronunciations);
    }

    const actions = el('div', 'flex gap-2 mt-auto pt-2');
    actions.appendChild(createChip({ text: 'Copy', onClick: () => navigator.clipboard.writeText(item.name) }));
    if (appState.options.mode === 'forge') {
        actions.appendChild(createChip({ text: '👍', classes: ['like-btn', item.liked ? 'active' : ''], onClick: () => stateManager.toggleLike(item.name) }));
        actions.appendChild(createChip({ text: '👎', classes: [appState.userBlacklist.includes(item.name.toLowerCase()) ? 'active' : ''], onClick: () => stateManager.toggleBlacklist(item.name) }));
    }
    card.appendChild(actions);
    return card;
  }
  
  // --- PROMPT ENGINEERING ---
  function buildForgePrompt(task, gender, sessionHistory) {
    const sessionMemory = sessionHistory.length > 0 ? `Avoid names from this session: ${sessionHistory.map(n=>n.name).join(', ')}.` : `This is the first generation.`;
    
    // IMPLEMENTATION: Advanced context fields are added to the task if they exist.
    const { surname, siblingNames, firstNameForMiddle } = appState.options;
    if (surname) task += ` Consider compatibility with surname: ${surname}.`;
    if (siblingNames) task += ` Harmonize with siblings: ${siblingNames}.`;
    if (firstNameForMiddle) task = `Generate ${DEFAULT_COUNT} middle names for "${firstNameForMiddle}". ` + task;

    return `
You are a poet-linguist specializing in name smithing.
== CRITICAL RULES ==
1.  **MULTI-LANGUAGE FUSION**: Invent names by fusing morphemes from 2-3 DIFFERENT languages from the TASK list.
2.  **ROOT FIDELITY**: The "roots" field must be an array detailing each morpheme's language and gloss.
== SESSION CONTEXT ==
${sessionMemory}
- **Inspirational Names**: ${appState.likedNames.map(n=>n.name).join(', ') || 'None.'}
- **Blacklisted Words**: ${appState.userBlacklist.join(', ') || 'None.'}
== OUTPUT FORMAT (JSON ONLY) ==
{"names": [{"name": "Astren", "meaning": "Evokes cosmic light.", "roots": ["astro (Greek: star)", "ren (Nordic: raven)"]}]}
== TASK ==
${task}
    `;
  }

  function buildHarmonizerPrompt(languages, gender, isAllLanguages) {
      // ... (Harmonizer prompt is unchanged)
  }
  
  // --- MAIN LOGIC ---
  async function doGenerate(context = {}) { /* ... */ }
  
  function updateGenerateButtonState() { /* ... */ }

  function initLayout() {
      ui.root.innerHTML = '';
      const appWrap = el('div','max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6');
      const left = el('div','md:col-span-1 bg-[#071425] border border-[#0e2334] rounded-xl p-5 flex flex-col gap-4 h-fit');
      const right = el('div','md:col-span-2 bg-[#071427] border border-[#0e2030] rounded-xl p-5 flex flex-col gap-4');
      
      const header = el('div', 'flex justify-between items-center');
      header.innerHTML = `<div><h1 class="text-xl font-semibold">NameForge</h1><div class="small-muted mt-1">Craft a name with meaning</div></div>`;
      left.append(header);

      const modeSwitcher = el('div', 'mode-toggle mt-4');
      modeSwitcher.append(createChip({ text: 'Forge', data: {mode: 'forge'}, onClick: () => stateManager.setMode('forge') }));
      modeSwitcher.append(createChip({ text: 'Harmonizer', data: {mode: 'harmonizer'}, onClick: () => stateManager.setMode('harmonizer') }));
      left.append(modeSwitcher);

      const controlsContainer = el('div', 'flex flex-col gap-4 mt-4');
      ui.controls.languageChips = el('div', 'flex flex-wrap gap-2');
      controlsContainer.append(createControlSection('Languages (choose 2-3)', ui.controls.languageChips));
      
      ui.controls.harmonizerToggleSection = el('div');
      ui.controls.harmonizerToggleSection.innerHTML = `<div class="toggle-switch"><span class="text-sm font-medium">Proper noun in all languages</span><input type="checkbox" id="harmonizer-toggle" class="toggle-switch-input"><label for="harmonizer-toggle" class="toggle-switch-label">Toggle</label></div>`;
      controlsContainer.append(ui.controls.harmonizerToggleSection);
      ui.controls.harmonizerToggleSection.querySelector('input').addEventListener('change', (e) => stateManager.setOption('harmonizerIsAllLanguages', e.target.checked));

      ui.controls.themeChips = el('div', 'flex flex-wrap gap-2');
      ui.controls.themesSection = createControlSection('Themes (choose 1–2)', ui.controls.themeChips);
      controlsContainer.append(ui.controls.themesSection);
      
      ui.controls.styleSection = createControlSection('Style', createSelectControl(STYLE_OPTIONS, appState.options.selectedStyle, 'selectedStyle'));
      controlsContainer.append(ui.controls.styleSection);
      
      // IMPLEMENTATION: Advanced Context section restored.
      const advancedSection = el('details', 'mt-2');
      advancedSection.innerHTML = `<summary class="text-sm font-medium cursor-pointer">Advanced Context</summary>`;
      const advancedGrid = el('div', 'grid grid-cols-2 gap-2 pt-2');
      advancedGrid.append(createLabeledInput({ stateKey: 'surname', placeholder: 'Surname' }));
      advancedGrid.append(createLabeledInput({ stateKey: 'siblingNames', placeholder: 'Sibling Names' }));
      const middleNameInput = createLabeledInput({ stateKey: 'firstNameForMiddle', placeholder: 'First Name for Middle' });
      middleNameInput.classList.add('col-span-2');
      advancedGrid.append(middleNameInput);
      advancedSection.append(advancedGrid);
      ui.controls.advancedContextSection = advancedSection;
      controlsContainer.append(advancedSection);
      
      left.append(controlsContainer);
      
      ui.controls.generateButton = el('button','bg-gradient-to-r from-[#3b82f6] to-[#2563eb] text-white px-4 py-2 rounded font-semibold shadow w-full mt-4');
      ui.controls.generateButton.textContent = 'Generate Names';
      ui.controls.generateButton.addEventListener('click', doGenerate);
      left.append(ui.controls.generateButton);

      right.innerHTML = `<div><h2 class="text-lg font-semibold">Results</h2></div>`;
      ui.results.panel = el('div', 'mt-2');
      right.append(ui.results.panel);
      
      appWrap.append(left, right);
      ui.root.append(appWrap);

      updateChipSelector(ui.controls.languageChips, LANG_OPTIONS, 'selectedLanguages');
      updateChipSelector(ui.controls.themeChips, THEME_OPTIONS, 'selectedThemes');
      updateResultsPanel();
      stateManager.setMode(appState.options.mode);
  }

  loadState();
  initLayout();
})();
  </script>
</body>
</html>

