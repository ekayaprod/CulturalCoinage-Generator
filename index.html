<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Morpheme Studio</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#071022; color:#E6EEF9; }
    .scrolling-panel::-webkit-scrollbar{ width:10px } .scrolling-panel::-webkit-scrollbar-thumb{ background:#213449; border-radius:8px }
    .fade { animation: fade 220ms ease-out; } @keyframes fade{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
    .small-muted { color:#9fb0c7; font-size:13px }
    .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); cursor:pointer; user-select:none; display: inline-flex; align-items: center; gap: 4px; }
    .chip.active { background: linear-gradient(90deg,#294e86,#2b6fb3); color:white; box-shadow:0 6px 18px rgba(41,78,134,0.14) }
    .spinner{ border:4px solid rgba(255,255,255,0.06); border-top-color:#60a5fa; border-radius:999px; width:36px; height:36px; animation:spin 0.9s linear infinite } @keyframes spin{ to{transform:rotate(360deg)} }
    .debug-panel { max-height: 200px; overflow-y: auto; }
    .thumb-btn.active svg { fill: #60a5fa; }
    .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 999px; }
    .progress-fill { height: 100%; background: #60a5fa; border-radius: 999px; transition: width 0.2s ease-out; }
    .cultural-origin { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
    .origin-celtic { background-color: #059669; color: #d1fae5; }
    .origin-nordic { background-color: #1d4ed8; color: #dbeafe; }
    .origin-latin { background-color: #be123c; color: #fee2e2; }
    .origin-turkish { background-color: #c2410c; color: #ffedd5; }
    .origin-greek { background-color: #b45309; color: #fef3c7; }
    .origin-japanese { background-color: #db2777; color: #fce7f3; }
    .origin-spanish { background-color: #ca8a04; color: #fef9c3; }
    .origin-irish { background-color: #16a34a; color: #dcfce7; }
    .origin-default { background-color: #4b5563; color: #f3f4f6; }
    .favorited { border-color: #fbbf24 !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
    .modal-backdrop {
        display: none; /* Hidden by default */
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        animation: fadeIn 150ms ease-out;
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal-content { animation: slideIn 200ms ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-6"></div>

  <script>
(function () {
  // --- CONFIG ---
  const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/";
  const APP_VERSION = "3.9";
  const DEFAULT_COUNT = 8;
  const LANG_OPTIONS = ["Turkish","Nordic","Latin","Celtic","Japanese","Greek","Spanish","Irish"];
  const THEME_OPTIONS = ["Nature","Cosmic","Balance","Strength","Water","Light","Shadow","Music", "Fire", "Mountain", "Ocean", "Sky", "Forest", "Mythic"];
  const STYLE_OPTIONS = ["Lyrical & Melodic","Archaic & Mythic","Minimalist & Modern","Heroic & Resonant", "Elegant & Refined", "Grounded & Earthy", "Mystical & Ethereal"];
  const MODEL_OPTIONS = [
    { value: "models/gemini-2.5-pro", text: "2.5 Pro (Highest Quality)" },
    { value: "models/gemini-2.5-pro-preview-06-05", text: "2.5 Pro Preview (Latest)" },
    { value: "models/gemini-2.5-flash", text: "2.5 Flash (Fast & Balanced)" },
    { value: "models/gemini-1.5-pro", text: "1.5 Pro (Legacy)" }
  ];

  // --- State ---
  const appState = {
    version: APP_VERSION,
    apiKey: "",
    isLoading: false,
    error: null,
    results: [],
    likedNames: [],
    selectedLanguages: ["Spanish", "Irish"],
    selectedThemes: ["Light","Balance"],
    selectedStyle: "Lyrical & Melodic",
    gender: "Unisex",
    surname: "",
    siblingNames: "",
    firstNameForMiddle: "",
    userLanguages: [],
    userBlacklist: [],
    rawApiResponse: null,
    sessionGeneratedNames: [],
    model: "models/gemini-2.5-pro",
    outputAlphabet: "English (Default)",
  };
  
  // --- UI Element Cache ---
  const ui = {
      root: document.getElementById('app'),
      controls: {},
      results: {},
      modals: {},
  };

  // --- Helpers ---
  const el = (tag, cls='') => { const d = document.createElement(tag); if (cls) d.className = cls; return d; };
  
  function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
  }

  const debouncedSaveState = debounce(saveState, 500);

  const showToast = (msg, isError = false) => {
    const t = el('div', `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow text-sm fade ${isError ? 'bg-red-800' : 'bg-[#0f2a41]'} text-white`);
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  };
  
  function saveState() {
    try {
        const stateToSave = { ...appState };
        delete stateToSave.isLoading;
        delete stateToSave.error;
        delete stateToSave.rawApiResponse;
        localStorage.setItem('morphemeStudioState', JSON.stringify(stateToSave));
    } catch (e) { console.warn("Could not save state to localStorage:", e); }
  }

  function loadState() {
      try {
        const saved = localStorage.getItem('morphemeStudioState');
        if (saved) {
            let parsed = JSON.parse(saved);
            if (!parsed.version || parsed.version < APP_VERSION) {
              parsed = {
                ...parsed,
                version: APP_VERSION,
                batchSize: undefined, phoneticPreference: undefined,
                culturalApproach: undefined, generationMode: undefined,
              };
            }
            const defaults = { likedNames: [], userLanguages: [], userBlacklist: [], gender: "Unisex", outputAlphabet: "English (Default)", model: "models/gemini-2.5-pro" };
            Object.assign(appState, { ...defaults, ...parsed });
        }
      } catch (e) { console.warn("Could not load state from localStorage:", e); }
  }

  function parseApiResponse(text) {
    if (!text) return [];
    let cleanedText = text
      .replace(/\/\/.*/g, '')
      .replace(/,(?=\s*[}\]])/g, '')
      .replace(/```[a-z]*\n?/gi, '')
      .replace(/```/g, '').trim();

    try {
      const parsed = JSON.parse(cleanedText);
      if (Array.isArray(parsed)) return parsed;
      if (parsed.names && Array.isArray(parsed.names)) return parsed.names;
      if (typeof parsed === "object") return Object.values(parsed).flat();
      return [];
    } catch (e) {
      console.warn("JSON parse failed:", e);
      return [];
    }
  }

  function processApiResponse(rawArray) {
    if (!rawArray?.length) return [];
    const fullBlacklist = appState.userBlacklist.map(b => b.toLowerCase());

    return rawArray.map(it => {
      let name = (it.name || "").toString().trim();
      let meaning = (it.meaning || "").toString().trim();
      let roots = (it.roots || "").toString().trim();
      let cluster = (it.cluster || "").toString().trim() || appState.selectedStyle;

      if (!name) return null;
      if (appState.outputAlphabet === 'English (Simplified/No Accents)') { 
        name = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }
      if (fullBlacklist.some(b => name.toLowerCase().includes(b))) return null;
      if (!meaning) { meaning = `A name evoking ${appState.selectedThemes.join(" and ").toLowerCase()} with a ${appState.selectedStyle.toLowerCase()} cadence.`;}

      return { name, meaning, roots, cluster, pronunciation: it.pronunciation || "", syllableCount: it.syllableCount || 0, isFavorited: false };
    }).filter(Boolean);
  }

  // --- UI Update Functions ---
  function updateResultsPanel(progressInterval = null) {
      ui.results.panel.innerHTML = '';
      if (appState.isLoading) {
          ui.results.panel.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 gap-4">
              <div class="spinner"></div>
              <div class="text-sm small-muted">Crafting ${DEFAULT_COUNT} unique names...</div>
              <div class="progress-bar w-48 rounded-full"><div class="progress-fill" style="width: 0%"></div></div>
            </div>`;
      } else if (appState.error) {
          if (progressInterval) clearInterval(progressInterval);
          const escapedError = String(appState.error).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          ui.results.panel.innerHTML = `<div class="bg-[#2b1a1a] border border-[#5b2626] rounded p-4"><div class="text-red-300 font-semibold">Error</div><div class="small-muted mt-2">${escapedError}</div></div>`;
          updateDebugViewer();
      } else if (!appState.results.length) {
          if (progressInterval) clearInterval(progressInterval);
          ui.results.panel.innerHTML = '<div class="flex-1 flex items-center justify-center small-muted h-full">No names yet â€” click Generate.</div>';
          updateDebugViewer();
      } else {
          if (progressInterval) clearInterval(progressInterval);
          const clusters = appState.results.reduce((acc, item) => {
              (acc[item.cluster] = acc[item.cluster] || []).push(item);
              return acc;
          }, {});
          Object.keys(clusters).sort().forEach(clusterName => {
              const clusterTitle = el('h3', 'text-md font-semibold text-blue-300 mt-4 first:mt-0');
              clusterTitle.textContent = clusterName;
              ui.results.panel.append(clusterTitle);
              const grid = el('div','grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2');
              clusters[clusterName].forEach(item => grid.append(createNameCard(item)));
              ui.results.panel.append(grid);
          });
      }
  }
  
  function updateControls() {
    updateChipSelector(ui.controls.languageChips, [...new Set([...LANG_OPTIONS, ...appState.userLanguages])]);
    updateChipSelector(ui.controls.themeChips, THEME_OPTIONS);
    ui.controls.generateButton.textContent = appState.firstNameForMiddle ? 'Generate Middle Names' : (appState.likedNames.length > 0 ? 'Riff on Liked' : 'Generate Names');
    updateGenerateButtonState();
  }

  function updateGenerateButtonState() {
    const isReady = appState.selectedLanguages.length >= 2 && appState.selectedThemes.length >= 1;
    if (ui.controls.generateButton) {
      ui.controls.generateButton.disabled = !isReady;
      ui.controls.generateButton.classList.toggle('opacity-50', !isReady);
      ui.controls.generateButton.classList.toggle('cursor-not-allowed', !isReady);
    }
  }

  function updateChipSelector(container, options) {
      container.innerHTML = '';
      const stateKey = container.dataset.stateKey;
      options.forEach(opt => {
          const c = el('button', 'chip'); c.textContent = opt; c.dataset.option = opt;
          if (appState[stateKey].includes(opt)) c.classList.add('active');
          container.append(c);
      });
  }
  
  function updateDebugViewer() {
    ui.debug.container.innerHTML = '';
    if (appState.rawApiResponse) {
      const details = el('details', 'mt-4');
      details.innerHTML = `<summary class="cursor-pointer text-sm small-muted">Show Raw Model Output</summary>
      <pre class="debug-panel bg-[#0b1622] border border-[#223447] rounded p-2 text-xs mt-2 whitespace-pre-wrap"></pre>
      <div class="flex gap-2 mt-2">
        <button class="chip" data-action="copy-debug">Copy Raw</button>
        <button class="chip" data-action="copy-parsed">Copy Parsed</button>
      </div>`;
      details.querySelector('pre').textContent = appState.rawApiResponse;
      ui.debug.container.append(details);
    }
  }

  function createNameCard(item) {
      const isLiked = appState.likedNames.some(n => n.name === item.name);
      const isDisliked = appState.userBlacklist.includes(item.name.toLowerCase());
      const card = el('div',`bg-[#081426] border border-[#123047] rounded p-4 flex flex-col gap-2 fade ${item.isFavorited ? 'favorited' : ''}`);
      card.dataset.nameCard = item.name;

      const header = el('div', 'flex items-start justify-between gap-2');
      const nameEl = el('div', 'text-xl font-semibold'); nameEl.textContent = item.name;
      header.append(nameEl);

      if (item.pronunciation) {
        const pronEl = el('div', 'italic small-muted text-xs'); pronEl.textContent = `/${item.pronunciation}/`;
        header.append(pronEl);
      }
      
      const meaningEl = el('div', 'italic small-muted'); meaningEl.textContent = item.meaning || 'â€”';
      const rootsEl = el('div', 'text-xs mt-auto small-muted');
      rootsEl.innerHTML = `<strong>Roots:</strong> ${item.roots || 'â€”'}`;

      const metaRow = el('div', 'flex items-center gap-2 mt-1 flex-wrap');
      if (item.syllableCount > 0) metaRow.insertAdjacentHTML('beforeend', `<span class="small-muted text-xs">${item.syllableCount} syllables</span>`);

      if (item.roots) {
        const origins = [...new Set(item.roots.match(/\(([^:)]+)/g))].map(o => o.substring(1).trim());
        origins.forEach(originText => {
            const matchedLang = LANG_OPTIONS.find(lang => originText.toLowerCase().includes(lang.toLowerCase()));
            const origin = matchedLang || originText.split(' ')[0];
            const originTag = el('span', `cultural-origin origin-${origin.toLowerCase()} origin-default`);
            originTag.textContent = origin;
            metaRow.append(originTag);
        });
      }
      
      const actions = el('div', 'flex flex-wrap gap-2 mt-2');
      actions.innerHTML = `
        <button class="chip" data-action="copy-name" data-name="${item.name}">Copy</button>
        <button class="chip thumb-btn ${isLiked ? 'active' : ''}" data-action="thumb-up" data-name="${item.name}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.247 4.86c.13-.25.39-.41.683-.41h1.146c.293 0 .553.16.683.41l1.838 3.515.01.011c.144.293.183.626.107.926-.076.3-.26.555-.504.708l-1.353.768c-.294.167-.655.158-.94-.02l-1.92-1.077c-.39-.218-.553-.69-.37-1.082l1.63-3.232z"/><path d="M8.864 1.34c.338 0 .64.19.782.493l1.838 3.515.01.011c.144.293.183.626.107.926-.076.3-.26.555-.504.708l-1.353.768c-.294.167-.655.158-.94-.02l-1.92-1.077c-.39-.218-.553-.69-.37-1.082L8.082 1.833c.142-.304.444-.493.782-.493zM14 13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5v-9A1.5 1.5 0 0 1 3.5 3H4a.5.5 0 0 1 0 1h-.5A.5.5 0 0 0 3 4.5v9a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 1 1 0v1z"/></svg></button>
        <button class="chip thumb-btn ${isDisliked ? 'active' : ''}" data-action="thumb-down" data-name="${item.name}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.247 11.14c.13.25.39.41.683.41h1.146c.293 0 .553-.16.683.41l1.838-3.515.01-.011c.144-.293.183-.626.107.926-.076-.3-.26-.555-.504-.708L12.02 5.25c-.294-.167-.655-.158-.94.02l-1.92 1.077c-.39.218-.553-.69-.37 1.082l1.63 3.232z"/><path d="M8.864 14.66c.338 0 .64.19.782-.493l1.838-3.515.01-.011c.144-.293.183-.626.107.926-.076-.3-.26-.555-.504-.708l-1.353-.768c-.294-.167-.655-.158-.94.02l-1.92 1.077c-.39-.218-.553-.69-.37 1.082l1.63 3.232c.142.304.444.493.782.493zM14 2.5a1.5 1.5 0 0 0-1.5-1.5h-9A1.5 1.5 0 0 0 2 2.5v9A1.5 1.5 0 0 0 3.5 13H4a.5.5 0 0 0 0-1h-.5a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 0 1 0v-1z"/></svg></button>
        <button class="chip" data-action="variants" data-name="${item.name}">Variants</button>`;
      
      card.append(header, meaningEl, rootsEl, metaRow, actions);
      return card;
  }
  
  function createContextInput(placeholder, stateKey, className = '') {
    const input = el('input', `w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm ${className}`);
    input.placeholder = placeholder; input.value = appState[stateKey];
    input.addEventListener('change', e => { 
      appState[stateKey] = e.target.value.trim();
      updateControls();
      debouncedSaveState(); 
    });
    return input;
  }

  function createAddButton(clickHandler) {
    const btn = el('button', 'bg-[#0e2436] border border-[#1b3146] px-3 py-2 rounded text-sm small-muted');
    btn.textContent = 'Add';
    btn.addEventListener('click', clickHandler);
    return btn;
  }
  
  function createControlSection(label, controlElement) {
    const section = el('div');
    const labelEl = el('label', 'text-sm font-medium');
    labelEl.textContent = label;
    controlElement.classList.add('mt-1');
    section.append(labelEl, controlElement);
    return section;
  }
  
  function createSelectControl(options, selectedValue, changeHandler) {
      const select = el('select', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
      options.forEach(opt => {
          const optionEl = el('option');
          if (typeof opt === 'object') {
            optionEl.value = opt.value;
            optionEl.textContent = opt.text;
          } else {
            optionEl.value = opt;
            optionEl.textContent = opt;
          }
          if (optionEl.value === selectedValue) optionEl.selected = true;
          select.append(optionEl);
      });
      select.addEventListener('change', changeHandler);
      return select;
  }

  function toggleModal(modal, show) {
    if (modal) modal.style.display = show ? 'flex' : 'none';
  }
  
  // --- Event Handlers ---
  function handleControlsClick(event) {
      const chip = event.target.closest('.chip[data-option]');
      if (chip) {
          const { option } = chip.dataset;
          const stateKey = chip.parentElement.dataset.stateKey;
          const max = stateKey === 'selectedLanguages' ? 3 : 2;
          appState[stateKey] = appState[stateKey].includes(option)
              ? appState[stateKey].filter(x => x !== option)
              : [...appState[stateKey], option].slice(-max);
          debouncedSaveState();
          updateControls();
      }
  }
  
  function handleResultsPanelClick(event) {
      const btn = event.target.closest('button[data-action]');
      if (!btn) return;
      const { action, name } = btn.dataset;
      const nameLower = name ? name.toLowerCase() : '';
      
      switch (action) {
        case 'copy-name':
          navigator.clipboard.writeText(name);
          showToast('Copied!');
          break;
        case 'thumb-up':
        case 'thumb-down':
          const isThumbUp = action === 'thumb-up';
          const isLiked = appState.likedNames.some(n => n.name === name);
          const isDisliked = appState.userBlacklist.includes(nameLower);

          if (isThumbUp) {
            if (isLiked) {
              appState.likedNames = appState.likedNames.filter(n => n.name !== name);
              showToast('Unliked!');
            } else {
              const nameObj = appState.results.find(r => r.name === name) || { name };
              if (nameObj) appState.likedNames.push(nameObj);
              if (isDisliked) appState.userBlacklist = appState.userBlacklist.filter(w => w !== nameLower);
              showToast('Liked!');
            }
          } else {
            if (!isDisliked) {
              appState.userBlacklist.push(nameLower);
              if (isLiked) appState.likedNames = appState.likedNames.filter(n => n.name !== name);
              appState.results = appState.results.filter(item => item.name.toLowerCase() !== nameLower);
              updateResultsPanel();
              showToast('Blacklisted & removed!');
            }
          }
          debouncedSaveState();
          updateControls();
          const card = ui.results.panel.querySelector(`[data-name-card="${name}"]`);
          if (card) {
            const upBtn = card.querySelector('[data-action="thumb-up"]');
            const downBtn = card.querySelector('[data-action="thumb-down"]');
            if (upBtn) upBtn.classList.toggle('active', appState.likedNames.some(n => n.name === name));
            if (downBtn) downBtn.classList.toggle('active', appState.userBlacklist.includes(nameLower));
          }
          break;
        case 'variants':
          doGenerate({ mode: 'variants', name });
          break;
        case 'copy-debug':
          navigator.clipboard.writeText(appState.rawApiResponse);
          showToast('Copied Raw Output!');
          break;
        case 'copy-parsed':
          navigator.clipboard.writeText(JSON.stringify(appState.results, null, 2));
          showToast('Copied Parsed JSON!');
          break;
        case 'copy-prompt':
          // The selector needs to be robust enough to find the <pre> tag within the results panel.
          const preContainer = event.target.closest('.flex-col, .bg-\\[\\#081426\\]');
          if (preContainer) {
            const pre = preContainer.querySelector('pre');
            if (pre) {
              navigator.clipboard.writeText(pre.textContent);
              showToast('Prompt Copied!');
            }
          }
          break;
      }
  }
  
  function createModal(title, contentId, closeId) {
    const modal = el('div', 'modal-backdrop items-center justify-center');
    modal.innerHTML = `
      <div class="modal-content bg-[#0e2030] border border-[#1b3146] rounded-lg p-6 flex flex-col gap-4 w-96 max-h-[80vh]">
        <h3 class="text-lg font-semibold">${title}</h3>
        <div id="${contentId}" class="flex-1 overflow-y-auto scrolling-panel pr-2"></div>
        <button id="${closeId}" class="chip bg-blue-800/50 justify-center">Close</button>
      </div>`;
    return modal;
  }

  function initLayout() {
    ui.root.innerHTML = '';
    const appWrap = el('div','max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6');
    const left = el('div','md:col-span-1 bg-[#071425] border border-[#0e2334] rounded-xl p-5 flex flex-col gap-4 h-fit');
    
    const header = el('div', 'flex justify-between items-center');
    header.innerHTML = `<div><h1 class="text-xl font-semibold">Morpheme Studio</h1><div class="small-muted mt-1">Craft a name with meaning</div></div>`;
    const settingsWrap = el('div', 'flex items-center gap-2');
    const settingsBtn = el('button', 'chip');
    settingsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413 1.4 2.397 0-2.81l-.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>`;
    settingsBtn.addEventListener('click', () => toggleModal(ui.modals.settings, true));
    
    const historyBtn = el('button', 'chip');
    historyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.234-.124 2.502.217 3.374.647.872.43 1.662.879 2.421.983.759.104 1.45.023 2.148-.21a.5.5 0 0 1 .546.886c-.602.232-1.203.29-1.75.186-.346-.074-.658-.148-.99-.234-.234-.058-.45-.09-.642-.11L11.21 3.42c-.568-.08-1.232-.303-1.843-.504C8.68 2.736 8.076 2.5 7.5 2.5c-.576 0-1.18.236-1.78.432-.6.198-1.27.426-1.86.504L3.21 3.92c-.21.028-.43.06-.66.118-.346.086-.68.17-.99.248-.547.133-1.15.08-1.75-.18a.5.5 0 0 1 .546-.886zM1.5 4.05v8.1c0 .27.22.5.5.5h12a.5.5 0 0 0 .5-.5v-8.1c-.602.232-1.203.29-1.75.186-.346-.074-.658-.148-.99-.234-.234-.058-.45-.09-.642-.11L11.21 3.42c-.568-.08-1.232-.303-1.843-.504C8.68 2.736 8.076 2.5 7.5 2.5c-.576 0-1.18.236-1.78.432-.6.198-1.27.426-1.86.504L3.21 3.92c-.21.028-.43.06-.66.118-.346.086-.68.17-.99.248-.547.133-1.15.08-1.75-.18a.5.5 0 1 1 .546-.886z"/></svg>`;
    historyBtn.addEventListener('click', () => { updateHistoryModal(); toggleModal(ui.modals.history, true); });

    header.append(settingsWrap); settingsWrap.append(historyBtn, settingsBtn); left.append(header);

    const controlsContainer = el('div', 'flex flex-col gap-4 mt-4');
    const languagesSection = el('div');
    languagesSection.innerHTML = `<label class="text-sm font-medium">Languages (choose 2â€“3)</label>`;
    ui.controls.languageChips = el('div', 'flex flex-wrap gap-2 mt-1');
    ui.controls.languageChips.dataset.stateKey = 'selectedLanguages';
    const addLangWrap = el('div', 'flex gap-2 mt-2');
    const langInput = el('input', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
    langInput.placeholder = 'Add a language...';
    const addLangBtn = createAddButton(() => {
        const newLang = langInput.value.trim();
        if (newLang && ![...LANG_OPTIONS, ...appState.userLanguages].map(l=>l.toLowerCase()).includes(newLang.toLowerCase())) {
            appState.userLanguages.push(newLang);
            appState.selectedLanguages = [...appState.selectedLanguages, newLang].slice(-3);
            debouncedSaveState(); updateControls();
        }
        langInput.value = '';
    });
    addLangWrap.append(langInput, addLangBtn);
    languagesSection.append(ui.controls.languageChips, addLangWrap);

    const themesSection = el('div');
    themesSection.innerHTML = `<label class="text-sm font-medium">Themes (choose 1â€“2)</label>`;
    ui.controls.themeChips = el('div', 'flex flex-wrap gap-2 mt-1');
    ui.controls.themeChips.dataset.stateKey = 'selectedThemes';
    themesSection.append(ui.controls.themeChips);

    const styleSel = createSelectControl(STYLE_OPTIONS, appState.selectedStyle, e => { appState.selectedStyle = e.target.value; debouncedSaveState(); });
    const genderSel = createSelectControl(["Unisex", "Male", "Female"], appState.gender, e => { appState.gender = e.target.value; debouncedSaveState(); });
    
    const advancedSection = el('details', 'mt-2');
    advancedSection.innerHTML = `<summary class="text-sm font-medium cursor-pointer">Advanced Context</summary>`;
    const advancedGrid = el('div', 'flex flex-col gap-4 pt-2');
    const contextGrid = el('div', 'grid grid-cols-2 gap-2');
    contextGrid.append(createContextInput("Surname", "surname"), createContextInput("Sibling Names", "siblingNames"), createContextInput("First Name", "firstNameForMiddle", "col-span-2"));
    advancedGrid.append(contextGrid);
    advancedSection.append(advancedGrid);
    
    controlsContainer.append(languagesSection, themesSection, createControlSection('Style', styleSel), createControlSection('Gender', genderSel), advancedSection);
    left.append(controlsContainer);

    const genControlsSection = el('div', 'flex flex-col gap-4 mt-4 border-t border-gray-700 pt-4');
    const btnWrap = el('div','flex flex-wrap gap-2');
    ui.controls.generateButton = el('button','bg-gradient-to-r from-[#3b82f6] to-[#2563eb] text-white px-4 py-2 rounded font-semibold shadow flex-1');
    ui.controls.generateButton.addEventListener('click', () => doGenerate());
    const clearBtn = el('button','bg-transparent border border-[#233542] px-3 py-2 rounded text-sm small-muted'); clearBtn.textContent = 'Clear';
    clearBtn.addEventListener('click', ()=>{ appState.results=[]; appState.error=null; appState.rawApiResponse=null; appState.sessionGeneratedNames = []; appState.likedNames = []; appState.userBlacklist = []; debouncedSaveState(); updateControls(); updateResultsPanel(); });
    btnWrap.append(ui.controls.generateButton, clearBtn);
    genControlsSection.append(btnWrap);
    left.append(genControlsSection);
    
    const right = el('div','md:col-span-2 bg-[#071427] border border-[#0e2030] rounded-xl p-5 flex flex-col gap-4');
    right.innerHTML = '<div><h2 class="text-lg font-semibold">Results</h2><div class="small-muted">Poetic, culturally coined names</div></div>';
    ui.results.panel = el('div','mt-2 p-3 bg-[#071a25] border border-[#0f2a3a] rounded-lg min-h-[280px] flex flex-col');
    ui.debug = { container: el('div') };
    
    const blacklistSection = el('div', 'mt-4 pt-4 border-t border-[#0e2334]');
    blacklistSection.innerHTML = '<h3 class="text-sm font-medium">Blacklist a Word</h3>';
    const blacklistWrap = el('div', 'flex gap-2 mt-2');
    const blacklistInput = el('input', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
    blacklistInput.placeholder = 'e.g., "dragon", "ae", "zor"';
    const blacklistBtn = createAddButton(() => {
        const newWord = blacklistInput.value.trim().toLowerCase();
        if (newWord) {
            if (!appState.userBlacklist.includes(newWord)) {
                appState.userBlacklist.push(newWord);
                appState.results = appState.results.filter(item => !item.name.toLowerCase().includes(newWord));
                debouncedSaveState(); updateResultsPanel(); showToast(`"${newWord}" added to blacklist!`);
            } else { showToast(`"${newWord}" is already on the blacklist.`); }
            blacklistInput.value = '';
        }
    });
    blacklistBtn.textContent = 'Blacklist';
    blacklistWrap.append(blacklistInput, blacklistBtn);
    blacklistSection.append(blacklistWrap);
    right.append(ui.results.panel, ui.debug.container, blacklistSection);
    appWrap.append(left, right);

    ui.modals.settings = createModal('Settings', 'settings-modal-content', 'close-settings-modal');
    ui.modals.history = createModal('Session Feedback', 'history-modal-content', 'close-history-modal');
    ui.root.append(appWrap, ui.modals.settings, ui.modals.history);

    const apiKeyInput = createContextInput('Paste API key', 'apiKey');
    apiKeyInput.type = 'password';
    apiKeyInput.addEventListener('change', e => { 
        if (e.target.value.trim() && !e.target.value.trim().startsWith('AIza')) showToast('Warning: Invalid API key format.', true);
    });
    
    const modelSel = createSelectControl(MODEL_OPTIONS, appState.model, e => { appState.model = e.target.value; debouncedSaveState(); });

    const alphabetOptions = ['English (Default)', 'English (Simplified/No Accents)'];
    const alphabetSel = createSelectControl(alphabetOptions, appState.outputAlphabet, e => { appState.outputAlphabet = e.target.value; debouncedSaveState(); });
    const settingsContent = ui.modals.settings.querySelector('#settings-modal-content');
    settingsContent.append(
        createControlSection('Gemini API Key', apiKeyInput), 
        createControlSection('Generation Model', modelSel),
        createControlSection('Output Character Set', alphabetSel)
    );
    
    document.getElementById('close-settings-modal').addEventListener('click', () => toggleModal(ui.modals.settings, false));
    document.getElementById('close-history-modal').addEventListener('click', () => toggleModal(ui.modals.history, false));
    left.addEventListener('click', handleControlsClick);
    right.addEventListener('click', handleResultsPanelClick);
  }

  function renderFeedbackList(container, title, items, options) {
    container.innerHTML = '';
    container.insertAdjacentHTML('beforeend', `<h4 class="font-semibold ${options.titleColor || 'text-blue-300'}">${title}</h4>`);
    
    if (options.input) {
      const inputWrap = el('div', 'flex gap-2 mt-2');
      const input = el('input', 'w-full bg-[#0b1622] border border-[#223447] rounded px-3 py-2 text-sm');
      input.placeholder = options.input.placeholder;
      const addBtn = createAddButton(() => options.input.onAdd(input));
      inputWrap.append(input, addBtn);
      container.append(inputWrap);
    }

    if (items.length > 0) {
      const list = el('div', 'flex flex-wrap gap-2 mt-2');
      items.forEach(item => {
        const chip = el('div', `chip ${options.chipClass || ''}`);
        const itemName = typeof item === 'object' ? item.name : item;
        chip.innerHTML = `<span>${itemName}</span>`;
        if (options.onRemove) {
          chip.insertAdjacentHTML('beforeend', `<button class="font-mono text-xs opacity-70 ml-1" data-action="remove" data-item="${itemName}">x</button>`);
        }
        list.append(chip);
      });
      container.append(list);
      if (options.onRemove) {
        list.addEventListener('click', (e) => {
          const removeBtn = e.target.closest('[data-action="remove"]');
          if (removeBtn) options.onRemove(removeBtn.dataset.item);
        });
      }
    } else {
      container.insertAdjacentHTML('beforeend', `<p class="small-muted mt-2 italic text-sm">${options.emptyText}</p>`);
    }
  }

  function updateHistoryModal() {
      const content = ui.modals.history.querySelector('#history-modal-content');
      content.innerHTML = '';
      const likedContainer = el('div', 'mb-4');
      renderFeedbackList(likedContainer, 'Liked Names (ðŸ‘)', appState.likedNames, { titleColor: 'text-blue-300', chipClass: 'active', emptyText: 'No names liked yet.' });
      
      const dislikedContainer = el('div');
      renderFeedbackList(dislikedContainer, 'Blacklisted Names (ðŸ‘Ž)', appState.userBlacklist, {
          titleColor: 'text-red-300', chipClass: 'bg-red-900/50', emptyText: 'No names blacklisted yet.',
          input: {
              placeholder: 'Add word to blacklist...',
              onAdd: (input) => {
                  const newWord = input.value.trim().toLowerCase();
                  if (newWord && !appState.userBlacklist.includes(newWord)) {
                      appState.userBlacklist.push(newWord);
                      debouncedSaveState(); updateHistoryModal();
                  }
                  input.value = '';
              }
          },
          onRemove: (item) => {
              appState.userBlacklist = appState.userBlacklist.filter(w => w !== item);
              debouncedSaveState(); 
              updateHistoryModal();
          }
      });
      content.append(likedContainer, dislikedContainer);
  }

  function buildSystemPrompt(task, gender, sessionHistory) {
    const fullBlacklist = [...appState.userBlacklist];
    const likedNames = appState.likedNames.map(n => n.name);
    const sessionMemoryInstruction = sessionHistory.length > 0 ? `Avoid repeating or too closely resembling these session names: ${sessionHistory.join(', ')}.` : `This is the first generation of this session.`;
    const longSessionInstruction = sessionHistory.length >= 20 ? `\n\nSTALENESS AVOIDANCE: This is a long session. You MUST diverge phonetically from the names provided in the session history. Your goal is new phonetic territory while retaining the core themes and style.` : '';

    return `
You are the Cultural Coinage Agent â€” a poet-linguist. Your craft is name-smithing.

CRITICAL RULE 1: MANDATORY & DIVERSE LANGUAGE FUSION
Every name MUST be an original invention, created by fusing morphemes from 2 or 3 DIFFERENT languages from the TASK list. A name is INVALID if its roots are from only one language or if it is a single, unmodified word. Example of VALID fusion: "sol (Latin: sun) + ren (Japanese: lotus)".

CRITICAL RULE 2: LANGUAGE & ROOT FIDELITY
You MUST use morphemes ONLY from the languages specified in the TASK. The "roots" field MUST be a technical breakdown showing each morpheme with its language and gloss. Any invented phonetic components MUST be marked as (coined).

PRINCIPLES OF THE CRAFT:
- Meaning vs. Roots: These fields must be distinct. The "meaning" is a poetic interpretation, NOT a literal translation. If you cannot create a specific meaning, weave together the user's selected THEMES and STYLE.
- Variant Quality: Variants must change at least one core morpheme or phoneme. Trivial respellings are forbidden.
- Gender Guidance: Male: favor consonant-final/strong clusters. Female: favor open syllables, vowel-rich endings. Unisex: neutral balance.

SESSION CONTEXT:
${sessionMemoryInstruction}${longSessionInstruction}
User Feedback:
- Inspirational (ðŸ‘) Names: ${likedNames.length > 0 ? likedNames.join(', ') : 'None yet.'} Use as stylistic guides.
- Blacklisted (ðŸ‘Ž) Names/Words: ${fullBlacklist.length > 0 ? fullBlacklist.join(', ') : 'None yet.'} Avoid names containing these words or with similar sounds/roots.

OUTPUT FORMAT:
Return ONLY a raw JSON array of objects. Do not include commentary.
{"name": "Astren", "meaning": "A name evoking cosmic guidance and strength, blending stellar light with the wisdom of ancient birds.", "roots": "astro (Greek: star) + ren (Nordic: raven)", "cluster": "${appState.selectedStyle}", "pronunciation": "AS-tren", "syllableCount": 2}

TASK:
${task}
    `;
  }

  async function callGeminiOnce(prompt) {
    const key = appState.apiKey.trim();
    // Note: The check for the key is now handled in doGenerate() to allow for prompt-only generation.
    const model = appState.model || "models/gemini-2.5-pro";
    const url = `${API_BASE_URL}${model}:generateContent`;
    const body = { 
      contents: [{ parts: [{ text: prompt }] }], 
      generationConfig: { temperature: 0.85, maxOutputTokens: 2048, candidateCount: 1, topP: 0.95, topK: 40 } 
    };
    const res = await fetch(`${url}?key=${encodeURIComponent(key)}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    if (!res.ok) throw new Error(`Gemini API error ${res.status}: ${await res.text()}`);
    const data = await res.json();
    return data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
  }

  async function doGenerate(context = {}) {
    if (appState.selectedLanguages.length < 2 || appState.selectedThemes.length < 1) {
      showToast("Please select at least 2 languages and 1 theme.", true);
      return;
    }
    appState.error = null; appState.results = []; appState.rawApiResponse = null;
    if (appState.sessionGeneratedNames.length > 20) appState.sessionGeneratedNames = appState.sessionGeneratedNames.slice(-20);
    
    let task;
    const allLangs = [...new Set([...appState.selectedLanguages, ...appState.userLanguages])];

    if (context.mode === 'variants') {
        task = `Generate ${DEFAULT_COUNT} variants of "${context.name}" using morphemes from: ${allLangs.join(', ')}. Style: "${appState.selectedStyle}".`;
    } else if (appState.firstNameForMiddle) {
        task = `Generate ${DEFAULT_COUNT} middle names for "${appState.firstNameForMiddle}" using morphemes from: ${allLangs.join(', ')}. Style: "${appState.selectedStyle}".`;
    } else if (appState.likedNames.length > 0) {
        const likedAnalysis = appState.likedNames.map(n => `${n.name} (${n.roots || 'unknown'})`).join('; ');
        task = `Analyze liked names: ${likedAnalysis}. Generate ${DEFAULT_COUNT} new names with similar qualities using morphemes from: ${allLangs.join(', ')}. Style: "${appState.selectedStyle}".`;
    } else {
        task = `Generate ${DEFAULT_COUNT} original names using morphemes from: ${allLangs.join(', ')}. Style: "${appState.selectedStyle}".`;
    }
    if (appState.siblingNames) task += ` Harmonize with siblings: ${appState.siblingNames}.`;
    if (appState.surname) task += ` Consider compatibility with surname: ${appState.surname}.`;
    
    const prompt = buildSystemPrompt(task, appState.gender, appState.sessionGeneratedNames);
    
    // FIX: Restore prompt generation for users without an API key.
    if (!appState.apiKey) {
        const escapedPrompt = String(prompt).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        ui.results.panel.innerHTML = `
            <div class="bg-[#081426] border border-[#123047] rounded p-4 flex flex-col gap-2">
                <h3 class="text-md font-semibold text-blue-300">API Key Missing</h3>
                <p class="small-muted">The prompt below has been generated. Copy it to use in your preferred LLM tool, like Google AI Studio.</p>
                <pre class="debug-panel bg-[#0b1622] border border-[#223447] rounded p-2 text-xs mt-2 whitespace-pre-wrap">${escapedPrompt}</pre>
                <button class="chip mt-2 self-start" data-action="copy-prompt">Copy Prompt</button>
            </div>
        `;
        updateDebugViewer(); // Clear any previous raw API response.
        return;
    }

    appState.isLoading = true;
    let progressInterval = null;
    let progress = 0;
    updateResultsPanel();
    const fill = ui.results.panel.querySelector('.progress-fill');
    if (fill) {
      progressInterval = setInterval(() => {
        progress = Math.min(progress + 10, 90);
        fill.style.width = `${progress}%`;
      }, 200);
    }

    try {
        const raw = await callGeminiOnce(prompt);
        appState.rawApiResponse = raw;
        if (raw) {
            const parsed = parseApiResponse(raw);
            const processed = processApiResponse(parsed);
            if (processed.length) appState.sessionGeneratedNames.push(...processed.map(p => p.name));
            appState.results = processed;
            if (!appState.results.length) {
                appState.error = appState.rawApiResponse ? "No valid names were parsed from the model's response." : "No suitable names were generated.";
            } else {
                showToast(`Generated ${appState.results.length} new names!`);
            }
        }
    } catch (err) {
      console.error('Generation error:', err);
      appState.error = err.message || String(err);
      if (err.message && (err.message.includes('404') || err.message.includes('Not found'))) {
        showToast("The selected model may not be enabled for your API key. Try switching models in Settings.", true);
      } else {
        showToast('Generation failed. Check API key and connection.', true);
      }
    } finally {
      appState.isLoading = false;
      if(progressInterval) clearInterval(progressInterval);
      updateResultsPanel();
    }
  }

  // --- Init ---
  loadState();
  initLayout();
  updateControls();
  updateResultsPanel();
})();
  </script>
</body>
</html>

